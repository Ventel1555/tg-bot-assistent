# Tg-bot-assistent

## Инструкция
1) Создать venv
2) ```pip install python-telegram-bot```
3) Заменить ```"YOUR_BOT_TOKEN"``` на реальный токен бота
4) Запустить скрипт

## Доступные команды
```/start``` - начало работы с ботом
```/register_support <token>``` - регистрация специалиста поддержки
> (SUPPORT_TOKEN = "super_secret_token_123")
```/available``` - переключение статуса доступности
```/end_chat``` - завершение текущего диалога
```/history``` - просмотр истории диалога с текущим клиентом
```/stats``` - просмотр статистики работы специалиста

## Цель и значение
Бота ассистент, где две роли пользователей, одни - тех поддержка, другие - клиенты.
Чтобы стать техподдержкой надо ввести спец команду с токеном. Токен ~~захардкожен~~. Есть бд (sqlite). Любое сообщение пользователя происходит приветствие и поиск свободного ассистента. Свободный ассистент тот, у кого флажок свободен или кто был в сети недавнее, или у кого последний диалог завершился раньше. Подбираем ассистента клиенту, и все сообщения пересылаем ему с подписью имени клиента, у клиента можно спросить имя в начале и сохранить. Все сообщения ассистента пересылаем клиенту. Если ассистент наберет команду завершить диалог, он становится свободным а клиенту приходит сообщение что тикет закрыт и ждем его снова. У ассистента есть команда чтобы посмотреть историю общения этого клиента, история отправляется файлом.

## Структура
1. Структура базы данных:
- Создаются две основные таблицы:
  ```sql
  users (
      user_id - ID пользователя в Telegram
      username - имя пользователя
      full_name - полное имя
      is_support - флаг является ли техподдержкой (0/1)
      current_chat_id - ID текущего активного чата
      last_online - время последнего онлайна
      is_available - флаг доступности (0/1)
  )

  chat_history (
      id - уникальный ID сообщения
      client_id - ID клиента
      support_id - ID специалиста поддержки
      message - текст сообщения
      sender_id - кто отправил сообщение
      timestamp - время отправки
  )
  ```

2. Процесс регистрации пользователей:
- Когда пользователь впервые запускает бота (/start):
  - Проверяется наличие в базе данных
  - Если новый пользователь - запрашивается имя
  - Сохраняется информация в таблице users

3. Регистрация специалиста поддержки:
```python
/register_support <token>
```
- Проверяется правильность токена (захардкожен в коде)
- Если токен верный:
  - Устанавливается флаг is_support = 1
  - Устанавливается is_available = 1
  - Обновляется last_online

4. Процесс поиска специалиста:
```python
def find_available_support():
```
Ищет по приоритетам:
- Сначала ищем доступных и недавно онлайн (до 5 минут)
- Затем просто доступных
- В последнюю очередь тех, кто давно завершил диалог

5. Обработка сообщений:
```python
async def handle_message():
```
Когда приходит сообщение:
- Определяется тип пользователя (клиент/поддержка)
- Для клиента:
  - Если нет активного чата - ищется свободный специалист
  - Если есть - сообщение пересылается текущему специалисту
- Для специалиста:
  - Сообщение пересылается привязанному клиенту
- Все сообщения сохраняются в chat_history

6. Управление статусом специалиста:
```python
/available - переключает статус доступности
/end_chat - завершает текущий диалог
```
При завершении диалога:
- Специалист помечается как свободный
- Очищается привязка клиента
- Клиенту отправляется уведомление

7. Просмотр истории:
```python
/history - показывает историю текущего диалога
/stats - показывает статистику работы
```
История включает:
- Все сообщения диалога
- Время отправки
- Имена отправителей
- Отправляется файлом

8. Основной цикл работы:
- Клиент пишет боту
- Бот ищет свободного специалиста
- Создаётся связка клиент-специалист
- Все сообщения пересылаются между ними
- История сохраняется в базе данных
- Специалист может завершить диалог

9. Статистика работы:
```python
async def support_stats():
```
Показывает:
- Общее количество клиентов
- Количество сообщений
- Последние диалоги
- Активность специалиста

10. Запуск бота:
```python
def main():
```
- Инициализация базы данных
- Регистрация всех обработчиков команд
- Настройка ConversationHandler для управления состояниями
- Запуск бота в режиме polling


### В планах
- докер
- историю сохранять в файл (?)